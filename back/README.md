## 背景
当前项目中主要涉及四种类型的时空数据（具体在`/type/base/DataSource`中定义），
包含轨迹数据（包含时空轨迹点）、微博数据（包含时空点）、POI数据（包含地理空间点）等。

由于单词查询的数据量比较大，采用时空立方体模型（Space-temporal Cube，STC）对上述数据进行存储，并建立查询索引（具体参考`/data/README`）。

因此在本服务中首先要做的事情就是将前端传过来的**时空条件转换成STC上的索引，并在相应数据源上进行查询并返回结果**。

另外在项目中引入了**查询条件推荐模块**，即根据用户的查询推理操作以及当前各数据源时空信息的分布来训练出一个模型，向用户推荐出当前状态中值得查询的几个候选条件。该模块基于 Python 开发，而本服务充当**数据库**的角色，通过 http 接口向其提供各类数据的基本信息。

## 接口文档
参考 [api.md](./api.md)

## 开发
基于 [Egg.js](https://eggjs.org/zh-cn/intro/index.html) 开发，首先确保**依赖的数据**（`data/node-server-data/`）存在当前项目中

```bash
npm i  #安装依赖
npm run dev #起端口运行
```

大致流程：
1. 接到一个新的需求，在文档中定义新的接口及输入输出，并与请求方确认
2. `router` 中定义接口，`controller` 处理接口逻辑，`service`中复杂数据处理逻辑细节
3. 针对接口对应的 controller 编写单元测试，并确保在部署环境中跑通
4. 在目标环境中部署，并通过日志进行监控和线上排错

## 测试
具体参考 [egg单元测试](https://eggjs.org/zh-cn/core/unittest.html)
在 `test` 对应目录中加入测试用例，通过 `npm run test <filePath>` 运行单个测试文件。
也可直接通过 `npm run test` 运行所有测试用例，且耗时较长。

## 部署
```bash
npm run start
```

- 默认会读取 `config.default.js` 和 `config.prod.js` 中的配置信息
- 需要考虑 **网络连接（ip、端口）** 和 **跨域 CORS** 的问题

## 问题记录

#### 应对在 py 模型训练时在循环内同时发起多个 http 请求而引起的**高并发**的问题
1. 尽量减少单次请求运行时间，控制在 100 ms 内。一般需要在编码层面进行优化，即尽量采用高效的运行方式。
2. 借助 node 中的 `cluster` 模块，同时开启多个进程，有效利用多个CPU来响应请求。在 egg 中**部署**时可通过设置 woerkers 的数据来实现。

#### 如何在JS写法上提高程序效率 
1. 采用最快的**循环写法**
  一开始为了实现方便基本上采用了最慢的 `arr.map`，后续改成 `arr.forEach` 或 `for`循环 会快很多
2. 尽量采用 `key => value` 的方式实现数据查找，会比循环中遍历查找快很多
3. 读取大文件到内存后，尽量采用**缓存**，避免多次重复读取造成的时间和内存上的浪费。同时需要注意不要**在缓存数据对象上直接进行修改操作**（一般需要深拷贝一份），否则可能会造成隐蔽的Bug


#### 内存问题
当前将数据存储于文件中，并在运行解决将数据 load 至内存中进行查询，需要注意 Node 中 **1.5G 的内存限制**，避免由于数据文件过大引起的内存溢出的错误。

1. 可采用 `--max-old-space-size=2048` 在启动时加大内存的分配
2. 使用 `Stream` 读取数据

#### 多数据源环境
由于在找 Case 的时候需要 Load 多个不同版本的数据，因此需要从多个不同配置的文件起几个不同实例的端口
1. 在 `config` 下新增 `config.casex.ts` 配置文件
  - 在配置文件中写入 `dataSourcePath` 用于配置*数据文件地址*，app 运行时自动添加该目录至 file.ts 工具中
2. 运行时通过 `EGG_SERVER_ENV=casex npm run dev` 或 `EGG_SERVER_ENV=casex npm run start` 来制定运行环境, 读取 casex 对应的配置项

#### 其他需要改进点
- 条件校验：
- 错误（异常情况处理）：
- 性能监控：对运行服务的**性能指标**以及报错异常等进行监控